<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Tree</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <style>
        .tab-content {
            margin-top: 20px;
            position: relative;
        }

        .tab-pane.collapsible {
            margin-top: 15px; /* Add some space below the toggle button */
        }

        .tab-pane.collapsible .tab-content-inner {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            margin-top: 10px;
        }

        .tab-pane.collapsible.collapsed .tab-content-inner {
            display: none;
        }

        .toggle-tab-content {
            position: absolute; /* Ensure it remains positioned relative to the tab-pane */
            right: 0px; /* Space from the right of the tab-pane */
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
            z-index: 10; /* Ensure it's above other elements */
        }

        .toggle-tab-content:hover {
            background: #0056b3;
        }

        .properties-column {
            flex: 1;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
        }

        .table-hover tbody tr:hover {
            background-color: #f1f1f1;
        }

        .form-control {
            border-radius: 4px;
        }

        #layoutConfig .form-label {
            font-size: 0.9rem;
        }

        #layoutConfig input,
        #layoutConfig select {
            font-size: 0.9rem;
        }
        
        #addLayerBtn {
            max-width: 250px; /* Set a reasonable max width */
            width: 100%; /* Ensure responsiveness */
            font-weight: bold; /* Highlight the text slightly */
            border-radius: 5px; /* Slightly rounded corners */
            padding: 8px 15px; /* Balanced padding for readability */
        }
    </style>
</head>
<body>
<div class="container-fluid mt-0">
    <ul class="nav nav-tabs" id="controlPanelTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="properties-tab" data-bs-toggle="tab" data-bs-target="#properties" type="button" role="tab" aria-controls="properties" aria-selected="true">Metadata-Based Layouts</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="predefined-tab" data-bs-toggle="tab" data-bs-target="#predefined" type="button" role="tab" aria-controls="predefined" aria-selected="false">Predefined Layouts</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="conditional-tab" data-bs-toggle="tab" data-bs-target="#conditional" type="button" role="tab" aria-controls="conditional" aria-selected="false">Conditional Actions</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="edit-layouts-tab" data-bs-toggle="tab" data-bs-target="#edit-layouts" type="button" role="tab" aria-controls="edit-layouts" aria-selected="false">Edit Layouts</button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Property-Based Layouts Tab -->
        <div class="tab-pane fade show active collapsible collapsed" id="properties" role="tabpanel" aria-labelledby="properties-tab">
            <div style="display: flex; align-items: center;">
                <button class="toggle-tab-content" aria-label="Toggle Properties">+</button>
            </div>
            <div class="tab-content-inner">
                <h5 class="mb-3">Metadata and Layout Configuration</h5>
                <div class="d-flex">
                    <div class="properties-column me-3">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h6 class="mb-0 me-3">Select Metadata</h6>
                            <input id="propertySearch" type="text" class="form-control form-control-sm me-3" style="width: 250px;" placeholder="Search properties...">
                            <div class="d-flex gap-2">
                                <button id="selectAllProps" class="btn btn-sm btn-primary">Select All</button>
                                <button id="deselectAllProps" class="btn btn-sm btn-secondary">Deselect All</button>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                            <table class="table table-bordered table-hover" id="propertiesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 10%;">Select</th>
                                        <th style="width: 60%;">Property Name</th>
                                        <th style="width: 30%;">Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    % for prop in tree_info['node_props']:
                                    <tr>
                                        <td class="text-center">
                                            <input type="checkbox" class="form-check-input selectProperty" value="{{ prop }}">
                                        </td>
                                        <td>{{ prop }}</td>
                                        <td class="propType">{{ tree_info['prop2type'][prop] }}</td>
                                    </tr>
                                    % end
                                </tbody>
                            </table>
                        </div>                        
                    </div>
                    
                    <!-- Layout Configuration Section -->
                    <div class="properties-column">
                        <h6 class="mb-3">Layout Configuration</h6>
                        <!-- Layout Selection -->
                        <select class="form-select mb-3" id="layout" name="layout">
                            <optgroup label="Categorical">
                                <option value="colorbranch-layout">Color Branch Layout</option>
                                <option value="label-layout">Label Layout</option>
                                <option value="rectangle-layout">Rectangular Layout</option>
                                <option value="categorical-bubble-layout">Bubble Layout</option>
                                <option value="background-layout">Background Layout</option>
                                <option value="categorical-matrix-layout">Categorical Matrix Layout</option>
                                <option value="piechart-layout">Piechart Layout</option>
                                <option value="profiling-layout">Profiling Layout</option>
                                <option value="textbranch-layout">Text Branch Layout </option>
                                <option value="nodesymbol-layout">Node Symbol Layout </option>
                            </optgroup>
                            <optgroup label="Binary">
                                <option value="binary-layout">Binary Layout</option>
                            </optgroup>
                            <optgroup label="Numerical">
                                <option value="branchscore-layout">Color Branch Layout</option>
                                <option value="heatmap-layout">Heatmap Layout</option>
                                <option value="heatmap-mean-layout">Heatmap Mean Layout</option>
                                <option value="heatmap-zscore-layout">Heatmap Z-Score Layout</option>
                                <option value="barplot-layout">Barplot Layout</option>
                                <option value="numerical-matrix-layout">Numerical Matrix Layout</option>
                                <option value="numerical-bubble-layout">Bubble Layout</option>
                            </optgroup>
                            <optgroup label="Analytic">
                                <option value="acr-discrete-layout">ACR Discrete Layout</option>
                                <option value="acr-continuous-layout">ACR Continuous Layout</option>
                                <option value="ls-layout">LS Layout</option>
                            </optgroup>
                        </select>
                        <div id="layoutConfig" class="layout-config">
                            <p class="text-muted">Select a layout to see configuration options.</p>
                        </div>
                        <!-- Config-->
                        <div id="layoutConfig" class="layout-config">
                            <div class="card mt-4 shadow-sm">
                                <div class="card-header bg-light d-flex align-items-center">
                                    <h5 class="mb-0 text-secondary">Layout Settings</h5>
                                </div>
                                <div class="card-body">
                                    <div id="layoutSettings" class="form-group">
                                        <!-- General Settings -->
                                        <h6 class="fw-bold mb-3 text-secondary">General Settings</h6>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label for="columnWidth" class="form-label small">Column Width</label>
                                                <input type="number" id="columnWidth" name="columnWidth" class="form-control" value="70">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="paddingX" class="form-label small">Padding X</label>
                                                <input type="number" class="form-control" id="paddingX" name="paddingX" value="1">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="paddingY" class="form-label small">Padding Y</label>
                                                <input type="number" class="form-control" id="paddingY" name="paddingY" value="0">
                                            </div>
                                        </div>
                    
                                        <!-- Numerical-Specific Settings -->
                                        <div id="internalNumerical" class="form-group mt-4" style="display: none;">
                                            <label for="internalNumRep" class="form-label small">Internal Number Representation</label>
                                            <select class="form-select" id="internalNumRep" name="internalNumRep">
                                                <option value="avg">Average</option>
                                                <option value="sum">Sum</option>
                                                <option value="max">Maximum</option>
                                                <option value="min">Minimum</option>
                                                <option value="std">Standard Deviation</option>
                                                <option value="none">None</option>
                                            </select>
                                        </div>
                    
                                        <!-- Categorical Layout Settings -->
                                        <div id="categoricalSettings" class="form-group mt-4">
                                            <label for="categoricalColorscheme" class="form-label small">Color Scheme</label>
                                            <select class="form-select" id="categoricalColorscheme" name="categoricalColorscheme">
                                                % for colormap in color_schemes:
                                                <option value="{{ colormap }}">{{ colormap }}</option>
                                                % end
                                            </select>
                                        </div>

                                        <!--text branch settings-->
                                        <div id="textbranchSettings" class="form-group mt-4" style="display: none;">
                                            
                                            <div class="form-group mt-3">
                                                <label for="textPosition" class="form-label small">Text Position</label>
                                                
                                                <select class="form-select" id="textPosition" name="textPosition">
                                                    <option value="branch_bottom">Branch Bottom</option>
                                                    <option value="branch_up">Branch Up</option>
                                                    <option value="branch_right">Branch Right</option>
                                                    <option value="aligned">Aligned</option>
                                                </select>
                                            </div>
                                        
                                        
                                            <div class="form-check form-group mt-3">
                                                <input class="form-check-input me-2" type="checkbox" value="unicolor" id="textunicolorOption" name="textunicolorOption">
                                                <label class="form-check-label small" for="textunicolorOption">Use Unicolor</label>
                                            </div>
                                            
                                            <div id="textunicolorPicker" class="form-group mt-3" style="display: none;">
                                                <label for="textunicolorColor" class="form-label small">Select Unicolor:</label>
                                                <input type="color" id="textunicolorColor" name="textunicolorColor" class="form-control" value="#ff0000">
                                            </div>
                                        
                                            <div id="textColorscheme" class="form-group mt-3">
                                                <label for="textColorschemeSelect" class="form-label small">Select Color Scheme:</label>
                                                <select class="form-select" id="textColorschemeSelect" name="textColorschemeSelect">
                                                    % for colormap in color_schemes:
                                                    <option value="{{ colormap }}">{{ colormap }}</option>
                                                    % end
                                                </select>
                                            </div>
                                                                                       
                                        </div> 
                                        
                                        <div id="nodesymbolSettins" class="form-group mt-4" style="display: none;">
                                            <label for="symbolOption" class="form-label small">Symbol option for node:</label>
                                            <select class="form-control" id="symbolOption" name="symbolOption">
                                                <option value="circle">Circle</option>
                                                <option value="square">Square</option>
                                                <option value="triangle">Triangle</option>
                                            </select>

                                            <label for="symbolSize" class="form-label small">Node Size or Radius</label>
                                            <input type="number" class="form-control" id="symbolSize" name="symbolSize" value="5">
                                            
                                            <label for="fgopacity" class="form-label small">Opacity</label>
                                            <input type="number" class="form-control" id="fgopacity" name="fgopacity" min="0" max="1" step="0.01" value="0.8">
                                        </div>

                                        <!-- Binary Layout Settings -->
                                        <div id="binarySettings" class="form-group mt-4" style="display: none;">
                                            <h6 class="fw-bold text-secondary">Binary Layout Settings</h6>
                                            <div id="aggregateSettings" class="form-group mt-3">
                                                <label for="aggregateOption" class="form-label small">Summary for Collapsed Nodes:</label>
                                                <select class="form-control" id="aggregateOption" name="aggregateOption">
                                                    <option value="gradient">Gradient</option>
                                                    <option value="aggregate">Aggregate</option>
                                                </select>
                                            </div>
                    
                                            <div class="form-check form-group mt-3">
                                                <input class="form-check-input" type="checkbox" value="unicolor" id="binaryunicolorOption" name="binaryunicolorOption">
                                                <label class="form-check-label small" for="binaryunicolorOption">Use Unicolor</label>
                                            </div>
                                            <div id="binaryunicolorPicker" class="form-group mt-3" style="display: none;">
                                                <label for="binaryunicolorColor" class="form-label small">Select Unicolor:</label>
                                                <input type="color" id="binaryunicolorColor" name="binaryunicolorColor" class="form-control" value="#ff0000">
                                            </div>
                    
                                            <div id="binaryColorScheme" class="form-group mt-3">
                                                <label for="binaryColorSchemeSelect" class="form-label small">Select Color Scheme:</label>
                                                <select class="form-select" id="binaryColorSchemeSelect" name="binaryColorScheme">
                                                    % for colormap in color_schemes:
                                                    <option value="{{ colormap }}">{{ colormap }}</option>
                                                    % end
                                                </select>
                                            </div>
                                        </div>
                    
                                        <!-- Numerical Settings -->
                                        <div id="numericalSettings" class="form-group mt-4" style="display: none;">
                                            <h6 class="fw-bold text-secondary">Numerical Settings</h6>
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="minVal" class="form-label small">Min Value (Auto-detected if empty):</label>
                                                    <input type="number" class="form-control" id="minVal" name="min_val" placeholder="Enter min value">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="maxVal" class="form-label small">Max Value (Auto-detected if empty):</label>
                                                    <input type="number" class="form-control" id="maxVal" name="max_val" placeholder="Enter max value">
                                                </div>
                                            </div>
                                            <div class="row g-3 mt-3">
                                                <div class="col-md-4">
                                                    <label for="colorMin" class="form-label small">Color Min:</label>
                                                    <input type="color" class="form-control" id="colorMin" name="color_min" value="#0000ff">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="colorMid" class="form-label small">Color Mid:</label>
                                                    <input type="color" class="form-control" id="colorMid" name="color_mid" value="#ffffff">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="colorMax" class="form-label small">Color Max:</label>
                                                    <input type="color" class="form-control" id="colorMax" name="color_max" value="#ff0000">
                                                </div>
                                            </div>
                                        </div>
                    
                                        <!-- Barplot -->
                                        <div id="barplotOptions" class="form-group mt-4" style="display: none;">
                                            <h6 class="fw-bold text-primary">Barplot Settings</h6>
                                            <label for="barplotWidth" class="form-label small">Barplot Column Width (px):</label>
                                            <input type="number" class="form-control mb-2" id="barplotWidth" name="barplotWidth" placeholder="Enter width" value="200">
                    
                                            <label for="barplotRange" class="form-label small">Custom Barplot Scale (Max Value):</label>
                                            <input type="number" class="form-control mb-2" id="barplotRange" name="barplotRange" placeholder="Enter max value for the property">
                    
                                            <label for="barplotColorOption" class="form-label small">Barplot Color:</label>
                                            <select class="form-control mb-2" id="barplotColorOption" name="barplotColorOption">
                                                <option value="same">Color Scheme</option>
                                                <option value="colorby">Fill by Property</option>
                                                <option value="custom">Custom Color</option>
                                            </select>
                                            <div id="barplotColorSettings" class="mt-3">
                                                <div class="form-group">
                                                    <label for="barplotColorScheme" class="form-label small">Barplot Color</label>
                                                    <select class="form-control" id="barplotColorScheme" name="barplotColorScheme">
                                                        % for colormap in color_schemes:
                                                        <option value="{{ colormap }}">{{ colormap }}</option>
                                                        % end
                                                    </select>
                                                </div>
                                                <div class="form-group mt-2" id="customColorWrapper" style="display: none;">
                                                    <label for="barplotCustomColor" class="form-label small">Select Custom Color:</label>
                                                    <input type="color" class="form-control" id="barplotCustomColor" name="barplotCustomColor" value="#0000ff">
                                                </div>
                                                <select class="form-control mt-2" id="barplotFillProperty" name="barplotFillProperty" style="display: none;">
                                                    % for prop in tree_info['node_props']:
                                                    <option value="{{ prop }}">{{ prop }}</option>
                                                    % end
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                        <button id="addLayerBtn" class="btn btn-success mt-3 mx-auto d-block">
                            Add Layout
                        </button>                        
                    </div>
                </div>
            </div>
        </div>


        <!-- Predefined Layouts Tab -->
        <div class="tab-pane fade collapsible collapsed" id="predefined" role="tabpanel" aria-labelledby="predefined-tab">
            <button class="toggle-tab-content" aria-label="Toggle Predefined">+</button>
            <div class="tab-content-inner">
                <div class="predefined-layouts">
                    <div class="row row-cols-1 row-cols-md-3 g-3">
                        <!-- Taxonomic Layouts Card -->
                        % if tree_info['taxonomic_annotation']:
                        <div class="col">
                            <div class="card shadow-sm h-100 d-flex flex-column">
                                <div class="card-header">
                                    <h6 class="mb-0 text-primary">Taxonomic Layouts</h6>
                                </div>
                                <div class="card-body flex-grow-1">
                                    <select id="taxonomicLayoutSelect" class="form-control mb-2">
                                        <option value="taxonclade-layout">Taxon Clade Layout</option>
                                        <option value="taxonrectangle-layout">Taxon Rectangle Layout</option>
                                        <option value="taxoncollapse-layout">Taxon Collapse Layout</option>
                                    </select>
                                </div>
                                <div class="card-footer mt-auto">
                                    <button id="activateTaxonomicLayout" class="btn btn-success w-100">Activate</button>
                                </div>
                            </div>
                        </div>
                        % else:
                        <div class="col">
                            <div class="card shadow-sm h-100 d-flex flex-column">
                                <div class="card-header">
                                    <h6 class="mb-0 text-danger">Taxonomic Layouts</h6>
                                </div>
                                <div class="card-body flex-grow-1">
                                    <p class="text-muted mb-0">The input tree does not contain taxonomic annotations.</p>
                                </div>
                            </div>
                        </div>
                        % end
        
                        <!-- Alignment Layouts Card -->
                        % if tree_info['alignment_annotation']:
                        <div class="col">
                            <div class="card shadow-sm h-100 d-flex flex-column">
                                <div class="card-header">
                                    <h6 class="mb-0 text-primary">Alignment Layouts</h6>
                                </div>
                                <div class="card-body flex-grow-1">
                                    <label for="alignmentType" class="fw-bold mb-2">Alignment Window:</label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label for="algStart" class="form-label small">Start</label>
                                            <input type="number" class="form-control form-control-sm" id="algStart" name="algStart" placeholder="Start position">
                                        </div>
                                        <div class="col-6">
                                            <label for="algEnd" class="form-label small">End</label>
                                            <input type="number" class="form-control form-control-sm" id="algEnd" name="algEnd" placeholder="End position">
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer mt-auto">
                                    <button id="activateAlignmentLayout" class="btn btn-success w-100">Activate</button>
                                </div>
                            </div>
                        </div>
                        % else:
                        <div class="col">
                            <div class="card shadow-sm h-100 d-flex flex-column">
                                <div class="card-header">
                                    <h6 class="mb-0 text-danger">Alignment Layouts</h6>
                                </div>
                                <div class="card-body flex-grow-1">
                                    <p class="text-muted mb-0">The input tree does not include alignment annotations.</p>
                                </div>
                            </div>
                        </div>
                        % end
        
                        <!-- Domain Layouts Card -->
                        % if tree_info['domain_annotation']:
                        <div class="col">
                            <div class="card shadow-sm h-100 d-flex flex-column">
                                <div class="card-header">
                                    <h6 class="mb-0 text-primary">Domain Layouts</h6>
                                </div>
                                <div class="card-body flex-grow-1"></div>
                                <div class="card-footer mt-auto">
                                    <button id="activateDomainLayout" class="btn btn-success w-100">Activate</button>
                                </div>
                            </div>
                        </div>
                        % else:
                        <div class="col">
                            <div class="card shadow-sm h-100 d-flex flex-column">
                                <div class="card-header">
                                    <h6 class="mb-0 text-danger">Domain Layouts</h6>
                                </div>
                                <div class="card-body flex-grow-1">
                                    <p class="text-muted mb-0">The input tree does not have domain annotations.</p>
                                </div>
                            </div>
                        </div>
                        % end
                    </div>
                </div>
            </div>
        </div>
        
        

        <!-- Conditional Actions Tab -->
        <div class="tab-pane fade collapsible collapsed" id="conditional" role="tabpanel" aria-labelledby="conditional-tab">
            <button class="toggle-tab-content" aria-label="Toggle Conditional">+</button>
            <div class="tab-content-inner">
                <h5>Conditional Actions (Highlight, Collapse, Prune)</h5>
                <div id="customQueryCardBody">
                    <div class="card-body">
                        <!-- Select Action Dropdown -->
                        <div class="form-group mb-4">
                            <label for="customQueryType" class="fw-bold">Select Action:</label>
                            <select class="form-control" id="customQueryType" name="customQueryType">
                                <option value="">-- Choose an action --</option>
                                <option value="highlight">Highlight</option>
                                <option value="collapse">Collapse</option>
                                <option value="prune">Prune</option>
                                % if tree_info['taxonomic_annotation']:
                                <option value="rank_limit">Limit by Taxonomic Rank (taxonomic trees only)</option>
                                % end
                            </select>
                        </div>
        
                        <!-- Query Fields in a Single Row -->
                        <div class="row g-2 align-items-end mb-4">
                            <div class="col-md-4">
                                <label for="queryProp" class="fw-bold">Select Property:</label>
                                <select class="form-control" id="queryProp" name="queryProp">
                                    % for prop in selected_props:
                                    <option value="{{ prop }}">{{ prop }}</option>
                                    % end
                                </select>
                            </div>
        
                            <div class="col-md-4">
                                <label for="queryOperation" class="fw-bold">Operation:</label>
                                <select class="form-control" id="queryOperation" name="queryOperation">
                                    <option value="=">Equals (=)</option>
                                    <option value="!=">Not Equals (!=)</option>
                                    <option value="contains">Contains</option>
                                    <option value="&gt;">Greater Than (&gt;)</option>
                                    <option value="&lt;">Less Than (&lt;)</option>
                                </select>
                            </div>
        
                            <div class="col-md-4">
                                <label for="queryValue" class="fw-bold">Enter Value:</label>
                                <input type="text" class="form-control" id="queryValue" name="queryValue" placeholder="Enter value">
                            </div>
                        </div>
        
                        <!-- Add Query Buttons -->
                        <div class="row mb-4">
                            <div class="col">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-secondary" id="addQueryBtn">Add</button>
                                    <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" id="addWithAnd">Add with AND</a></li>
                                        <li><a class="dropdown-item" href="#" id="addWithOr">Add with OR</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col">
                                <label for="queryBox" class="fw-bold">Current Query:</label>
                                <textarea class="form-control" id="queryBox" name="queryBox" rows="3" readonly></textarea>
                                <small><a href="#" id="clearQueryBox" class="text-danger">Clear Query</a></small>
                            </div>
                        </div>
        
                        <!-- Taxonomic Rank Selection -->
                        <div id="taxonomicOptions" class="form-group mb-4" style="display:none">
                            <label for="rankSelection" class="form-label fw-bold">Select Taxonomic Rank:</label>
                            <select id="rankSelection" name="taxonomicRanks" class="form-control">
                                % for rank in tree_info['rank_list']:
                                <option value="{{ rank }}">{{ rank }}</option>
                                % end
                            </select>
                        </div>
        
                        <!-- Execute Action Button -->
                        <div class="text-center mt-4">
                            <button id="sendQuery" class="btn btn-success px-4">Execute Action</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        

        <!-- Edit Layouts Tab -->
        <div class="tab-pane fade collapsible collapsed" id="edit-layouts" role="tabpanel" aria-labelledby="edit-layouts-tab">
            <button class="toggle-tab-content" aria-label="Toggle Edit Layouts">+</button>
            <div class="tab-content-inner">
                <h5>Edit and Manage Layouts</h5>
                <div class="table-responsive">
                    <!-- Table Container with Scroll -->
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
                        <table class="table table-bordered table-hover table-sm mb-0">
                            <thead class="table-light sticky-top" style="z-index: 1;">
                                <tr class="text-center">
                                    <th style="width: 30%;">Layout</th>
                                    <th style="width: 40%;">Applied Properties</th>
                                    <th style="width: 30%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="activeLayoutsTable">
                                % for layout in layouts_metadata:
                                <tr>
                                    <td class="align-middle text-center">{{ layout['layout_name'] }}</td>
                                    <td>
                                        <ul class="list-unstyled mb-0 text-secondary">
                                            % for prop in layout['applied_props']:
                                            <li>{{ prop }}</li>
                                            % end
                                        </ul>
                                    </td>
                                    <td class="text-center align-middle">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-pencil-square me-1"></i>Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-layout-btn">
                                                <i class="bi bi-trash-fill me-1"></i>Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                % end
                            </tbody>
                        </table>
                        <!-- Hidden input to store the current layouts_metadata -->
                        <input id="layoutsMetadataInput" type="hidden" value="{{ layouts_metadata_json }}">
                    </div>
                    <!-- Apply Changes Button -->
                    <div class="text-center mt-4">
                        <button id="applyChangesBtn" class="btn btn-success px-4">
                            <i class="bi bi-check-circle-fill me-2"></i>Apply Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Iframe container -->
    <div class="position-relative mt-3">
        <iframe src="http://localhost:5051" id="treeIframe" width="100%" height="800px" frameborder="0"
            allowfullscreen></iframe>
    </div>

    <!-- Back Home and Utility Buttons -->
    <div class="mt-3 d-flex flex-wrap align-items-center gap-2">
        <button class="btn btn-primary" onclick="window.location.reload();">Refresh View</button>
        <button class="btn btn-secondary" id="fullscreenBtn">Fullscreen</button>
        <button id="resetTreeBtn" class="btn btn-danger">Reset Tree</button>
        <a href="/stop_explore" class="btn btn-primary">Back Home</a>
    </div>

</div>
<!-- Modal for Editing Layout Config -->
<div class="modal fade" id="editLayoutModal" tabindex="-1" aria-labelledby="editLayoutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editLayoutModalLabel">Edit Layout Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editLayoutForm">
                    <input type="hidden" id="editLayoutName" name="layout_name">

                    <!-- Placeholder for Config Fields -->
                    <div id="configFieldsContainer"></div>

                    <!-- Placeholder for Layer Fields -->
                    <div id="layerFieldsContainer"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveLayoutChanges">Save Changes</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleButtons = document.querySelectorAll('.toggle-tab-content');

        // Collapse all panels initially
        document.querySelectorAll('.tab-pane').forEach(tabPane => {
            tabPane.classList.add('collapsed');
        });

        // Initialize default tab
        const defaultTab = document.querySelector('#properties');
        const defaultToggleButton = defaultTab.querySelector('.toggle-tab-content');
        defaultTab.classList.add('collapsed');
        defaultToggleButton.textContent = '+';

        // Toggle functionality for panels
        toggleButtons.forEach(button => {
            button.addEventListener('click', function () {
                const tabPane = this.closest('.tab-pane');
                tabPane.classList.toggle('collapsed');
                this.textContent = tabPane.classList.contains('collapsed') ? '+' : '-';
            });
        });

        // Expand panel when tab is clicked
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tabButton => {
            tabButton.addEventListener('click', function () {
                const targetId = this.getAttribute('data-bs-target');
                const targetPane = document.querySelector(targetId);

                // Collapse all other panels
                document.querySelectorAll('.tab-pane').forEach(tabPane => {
                    tabPane.classList.add('collapsed');
                    tabPane.querySelector('.toggle-tab-content').textContent = '+';
                });

                // Expand the selected tab panel
                targetPane.classList.remove('collapsed');
                targetPane.querySelector('.toggle-tab-content').textContent = '-';
            });
        });
    });
</script>
<script>
    // this is for the layout configuration section
    // Search Functionality
    document.getElementById('propertySearch').addEventListener('input', function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll('#propertiesTable tbody tr');

        rows.forEach(row => {
            const propertyName = row.cells[1]?.textContent.toLowerCase() || '';
            const propertyType = row.cells[2]?.textContent.toLowerCase() || '';
            if (propertyName.includes(filter) || propertyType.includes(filter)) {
                row.style.display = 'table-row';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // Track selected properties
    let layers = [];
    const selectedProperties = [];
    
    // Handle Select All button
    $('#selectAllProps').click(() => {
        $('.selectProperty').prop('checked', true);
        updateSelectedProperties();
    });

    // Handle Deselect All button
    $('#deselectAllProps').click(() => {
        $('.selectProperty').prop('checked', false);
        updateSelectedProperties();
    });

    // Update selected properties array
    function updateSelectedProperties() {
        selectedProperties.length = 0; // Clear current selections
        $('.selectProperty:checked').each(function () {
            selectedProperties.push($(this).val());
        });
    }

    // Handle individual property selection
    $(document).on('change', '.selectProperty', function () {
        updateSelectedProperties();
    });

    // Toggle Layout Config Section
    $('#selectLayoutBtn').click(() => {
        const layoutConfigSection = $('#layoutConfigSection');
        if (layoutConfigSection.is(':visible')) {
            layoutConfigSection.hide(); // Hide the section
            $('#selectLayoutBtn').text('Show Layout Config'); // Update button text
        } else {
            if (selectedProperties.length === 0) {
                alert('Please select at least one property.');
                return;
            }
            layoutConfigSection.show(); // Show the section
            $('#selectLayoutBtn').text('Hide Layout Config'); // Update button text
        }
    });
    
    // Handle Add Layout Button
    $('#addLayerBtn').click(() => {
        // // Custom query settings
        const queryType = null;
        const query = null;
        const rankSelection = null;
        // const queryType = document.getElementById('customQueryType').value;
        // const query = document.getElementById('queryBox').value;

        // Categorical layout settings
        const categoricalColorscheme = document.getElementById('categoricalColorscheme').value;
        
        // Text Branch layout settings
        const textPosition = document.getElementById('textPosition').value;
        const istextUnicolor = document.getElementById('textunicolorOption').checked;
        const textColorScheme = istextUnicolor ? null : document.getElementById('textColorschemeSelect').value;
        const textunicolorColor = istextUnicolor ? document.getElementById('textunicolorColor').value : null;
        

        // Node Symbol Layout settings
        const symbolOption = document.getElementById('symbolOption').value;
        const symbolSize = document.getElementById('symbolSize').value;
        const fgopacity = document.getElementById('fgopacity').value;

        // Binary layout settings
        const isbinaryUnicolor = document.getElementById('binaryunicolorOption').checked;
        const binaryColorScheme = isbinaryUnicolor ? null : document.getElementById('binaryColorSchemeSelect').value;
        const binaryunicolorColor = isbinaryUnicolor ? document.getElementById('binaryunicolorColor').value : null;
        const aggregateOption = document.getElementById('aggregateOption').value;

        // numerical layout settings
        const minVal = document.getElementById('minVal').value;
        const maxVal = document.getElementById('maxVal').value;
        const colorMin = document.getElementById('colorMin').value;
        const colorMid = document.getElementById('colorMid').value;
        const colorMax = document.getElementById('colorMax').value;

        // Barplot layout settings
        const barplotWidth = document.getElementById('barplotWidth').value;
        const barplotScaleProperty = document.getElementById('barplotScaleProperty')?.value || null;
        const barplotRange = document.getElementById('barplotRange').value;
        const barplotColorOption = document.getElementById('barplotColorOption').value;
        const barplotColorScheme = document.getElementById('barplotColorScheme').value;
        const barplotFillProperty = document.getElementById('barplotFillProperty').value;
        const barplotCustomColor = document.getElementById('barplotCustomColor').value;

        // alignment layout settings
        const algStart = document.getElementById('algStart')?.value || null;
        const algEnd = document.getElementById('algEnd')?.value || null;
        const props = selectedProperties;
        const layout = $('#layout').val();
        if (!layout) {
            alert('Please select a layout.');
            return;
        }
        
        const layer = {
            layout,
            props,
            
            queryType,
            query,
            rankSelection,
            
            categoricalColorscheme,
            
            textColorScheme,
            textPosition,
            textunicolorColor,
            
            symbolOption,
            symbolSize,
            fgopacity,

            isbinaryUnicolor,
            binaryColorScheme,
            binaryunicolorColor,
            aggregateOption,
            minVal,
            maxVal,
            colorMin,
            colorMid,
            colorMax,
            barplotWidth,
            barplotScaleProperty,
            barplotRange,
            barplotColorOption,
            barplotColorScheme,
            barplotFillProperty,
            barplotCustomColor,
            algStart,
            algEnd
        };
        layers.push(layer);

        const columnWidth = $('#columnWidth').val();
        if (!selectedProperties.length) {
            alert('Please select properties before adding a layout.');
            return;
        }
        const paddingX = document.getElementById("paddingX").value || null;
        const paddingY = document.getElementById("paddingY").value || null;
        
        // Numerical-specific setting (applies only if a numerical layout exists in layers)
        let internalNumRep = null;
        const numericalLayouts = [
            "branchscore-layout",
            "heatmap-layout",
            "heatmap-mean-layout",
            "heatmap-zscore-layout",
            "barplot-layout",
            "numerical-matrix-layout",
            "numerical-bubble-layout",
        ];
        if (numericalLayouts.includes(layout)) {
            internalNumRep = document.getElementById("internalNumRep").value || null;
        }

        const layersData = JSON.stringify(layers);

        // Construct the form data to send to the backend
        const formData = {
            layers: layersData,
            column_width: columnWidth,
            padding_x: paddingX,
            padding_y: paddingY,
            internal_num_rep: internalNumRep
        };
        
        // Submit the data to the backend
        $.post(
            '/explore_tree/{{treename}}',
            formData,
            (response) => {
                console.log('Layout added:', response);
                //alert('Layout added successfully!');
                // Optionally reset the UI after a successful submission
                $('.selectProperty').prop('checked', false);
                selectedProperties.length = 0;
                $('#layoutConfigSection').hide();

                // Refresh the window after successful submission
                window.location.reload();
            }
        ).fail((error) => {
            console.error('Error adding layout:', error);
            alert('Failed to add layout. Please try again.');
        });
    });

    function activateLayout(layoutName) {
        if (layoutName === 'alignment-layout') {
            const algStart = document.getElementById('algStart')?.value || null;
            const algEnd = document.getElementById('algEnd')?.value || null;

            // Add the layer only if both algStart and algEnd are not null
            if (algStart !== null && algEnd !== null) {
                const layer = {
                    layout: layoutName,
                    props: [],
                    algStart,
                    algEnd
                };
                layers.push(layer);
            } else {
                const layer = { layout: layoutName, props: [] };
                layers.push(layer);
            }
        } else {
            const layer = { layout: layoutName, props: [] }; // No properties for these layouts
            layers.push(layer);
        };


        const layersData = JSON.stringify(layers);
        const columnWidth = $('#columnWidth').val();
        const paddingX = document.getElementById("paddingX").value || null;
        const paddingY = document.getElementById("paddingY").value || null;
        let internalNumRep = null;

        const formData = {
            layers: layersData,
            column_width: columnWidth,
            padding_x: paddingX,
            padding_y: paddingY,
            internal_num_rep: internalNumRep
        };

        $.post(
            '/explore_tree/{{treename}}',
            formData,
            (response) => {
                console.log(`${layoutName} activated:`, response);
                window.location.reload();
            }
        ).fail((error) => {
            console.error(`Error activating ${layoutName}:`, error);
            alert(`Failed to activate ${layoutName}. Please try again.`);
        });
    }

    // Usage
    $('#activateTaxonomicLayout').click(() => activateLayout($('#taxonomicLayoutSelect').val()));
    $('#activateAlignmentLayout').click(() => activateLayout('alignment-layout'));
    $('#activateDomainLayout').click(() => activateLayout('domain-layout'));


    document.getElementById('resetTreeBtn').addEventListener('click', () => {
        if (!confirm('Are you sure you want to reset the tree?')) return;
        fetch('/explore_tree/{{ treename }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ reset_tree: true })
        })
        .then(response => {
            window.location.reload();
        })
        .then(data => {
            // Update the tree display dynamically
            document.getElementById('treeContainer').innerHTML = data;
        })
        .catch(error => console.error('Error:', error));
    });
    
    

</script>
<script>
    // === Edit Layout Functionality ===
    document.addEventListener('DOMContentLoaded', () => {
        const tableBody = document.getElementById('activeLayoutsTable');
        const layoutsMetadataInput = document.getElementById('layoutsMetadataInput');
        
        // Parse the initial metadata value into an array
        let layoutsMetadata = JSON.parse(layoutsMetadataInput.value);

        // Get color schemes passed from the backend
        const colorSchemes = {{!color_schemes}}; // Rendered directly in template

        // Function to update the hidden input field
        function updateHiddenInput() {
            layoutsMetadataInput.value = JSON.stringify(layoutsMetadata);
        }

        // Function to find and remove layout metadata by name
        function removeLayoutMetadata(layoutName) {
            const layoutIndex = layoutsMetadata.findIndex(layout => layout.layout_name === layoutName);

            if (layoutIndex !== -1) {
                // Remove only the selected layout from the metadata array
                layoutsMetadata.splice(layoutIndex, 1);
                // Update the hidden input with the modified array
                updateHiddenInput();
            }
        }

        // Handle Delete Button Click
        tableBody.addEventListener('click', function (e) {
            if (e.target.closest('.delete-layout-btn')) {
                const row = e.target.closest('tr'); // Find the table row
                const layoutName = row.querySelector('td:nth-child(1)').innerText.trim(); // Get layout name
                
                // Remove the row from the table
                row.remove();

                // Remove the corresponding layout from the metadata
                removeLayoutMetadata(layoutName);
            }
        });

        

        // Populate the modal with the layout's configuration and layer fields
        function populateEditForm(layoutName) {
            const layout = layoutsMetadata.find(l => l.layout_name === layoutName);
            console.log(layout);
            const selectedProps = {{!selected_props}}; 
            if (layout) {
                document.getElementById('editLayoutName').value = layout.layout_name;

                // Generate Config Fields
                const configContainer = document.getElementById('configFieldsContainer');
                configContainer.innerHTML = ''; // Clear previous fields
                for (const [key, value] of Object.entries(layout.config)) {
                    const field = generateInputField(key, value, 'config');
                    configContainer.appendChild(field);
                }

                // Generate Layer Fields
                const layerContainer = document.getElementById('layerFieldsContainer');
                layerContainer.innerHTML = ''; // Clear previous fields
                for (const [key, value] of Object.entries(layout.layer)) {
                    const field = generateInputField(key, value, 'layer');
                    layerContainer.appendChild(field);
                }

                const layoutPrefix = layout.layout_name.split('_')[0].toLowerCase(); // Extract prefix and convert to lowercase
                // Handle Text Branch Layout Specific Settings
                if (layoutPrefix === 'textbranch') {
                    const istextUnicolor = document.querySelector('select#layer-istextUnicolor');
                    const textunicolorColor = document.querySelector('input#layer-textunicolorColor');
                    const textColorScheme = document.querySelector('select#layer-textColorScheme');
                    if (istextUnicolor) {
                        istextUnicolor.addEventListener('change', function () {
                        if (this.value === 'True') {
                            textunicolorColor.disabled = false; // Enable textunicolorColor
                            textColorScheme.disabled = true; // Disable textColorScheme
                        } else {
                            textunicolorColor.disabled = true; // Disable textunicolorColor
                            textColorScheme.disabled = false; // Enable textColorScheme
                        }
                    });
                    };
                    // Trigger change event to set the initial state
                    istextUnicolor.dispatchEvent(new Event('change'));
                    
                }
                
                // Handle Numerical-Matrix Specific Settings
                if (layoutPrefix === 'numerical-matrix') {
                    const minValInput = document.querySelector('input#layer-minVal');
                    const maxValInput = document.querySelector('input#layer-maxVal');

                    if (minValInput) {
                        minValInput.disabled = true; // Disable minVal input
                        minValInput.parentElement.style.opacity = '0.5'; // Optional: Indicate inactivity visually
                    }

                    if (maxValInput) {
                        maxValInput.disabled = true; // Disable maxVal input
                        maxValInput.parentElement.style.opacity = '0.5'; // Optional: Indicate inactivity visually
                    }
                }

                // Handle Barplot-Specific Settings
                if (layoutPrefix === 'barplot') {
                    const barplotColorOption = document.querySelector('select#layer-barplotColorOption');
                    const barplotColor = document.querySelector('input#layer-barplotColor');
                    const barplotFillProperty = document.querySelector('select#layer-barplotFillProperty');

                    // Ensure options are generated
                    if (barplotColorOption) {
                        barplotColorOption.innerHTML = `
                            <option value="same" ${layout.layer.barplotColorOption === 'same' ? 'selected' : ''}>Same</option>
                            <option value="colorby" ${layout.layer.barplotColorOption === 'colorby' ? 'selected' : ''}>Color by Property</option>
                        `;

                        // Add change listener for the dropdown
                        barplotColorOption.addEventListener('change', function () {
                            if (this.value === 'same') {
                                barplotColor.disabled = false; // Enable barplotColor
                                barplotFillProperty.disabled = true; // Disable barplotFillProperty
                            } else if (this.value === 'colorby') {
                                barplotColor.disabled = true; // Disable barplotColor
                                barplotFillProperty.disabled = false; // Enable barplotFillProperty
                            }
                        });

                        // Trigger change event to set the initial state
                        barplotColorOption.dispatchEvent(new Event('change'));
                    }

                    // Populate barplotFillProperty options with properties
                    if (barplotFillProperty) {
                        barplotFillProperty.innerHTML = '';
                        selectedProps.forEach(prop => {
                            const option = document.createElement('option');
                            option.value = prop;
                            option.textContent = prop;
                            if (layout.layer.barplotFillProperty === prop) {
                                option.selected = true;
                            }
                            barplotFillProperty.appendChild(option);
                        });
                    }
                }

            }
        }

        // Generate dynamic input fields based on key-value pairs
        function generateInputField(key, value, type) {
            const container = document.createElement('div');
            container.classList.add('mb-3');

            const label = document.createElement('label');
            label.setAttribute('for', `${type}-${key}`);
            label.classList.add('form-label');
            label.textContent = key;

            let input;

            // Special handling for categoricalColorscheme or similar dropdown fields
            if (key === 'categoricalColorscheme' || key === 'textColorScheme') {
                input = document.createElement('select');
                input.classList.add('form-control');
                input.setAttribute('id', `${type}-${key}`);
                input.setAttribute('name', `${type}-${key}`);
                colorSchemes.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color;
                    option.textContent = color;
                    if (color === value) {
                        option.selected = true;
                    }
                    input.appendChild(option);
                });
            } else if (key === 'istextUnicolor') {
                input = document.createElement('select');
                input.classList.add('form-control');
                input.setAttribute('id', `${type}-${key}`);
                input.setAttribute('name', `${type}-${key}`);
                ['True', 'False'].forEach(optionValue => {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionValue;
                    if (optionValue === value) {
                        option.selected = true;
                    }
                    input.appendChild(option);
                });
            } else if (key === 'textunicolorColor') {
                input = document.createElement('input');
                input.setAttribute('type', 'color'); // Explicitly set type="color"
                input.setAttribute('id', `${type}-${key}`);
                input.setAttribute('name', `${type}-${key}`);
                input.classList.add('form-control');
                input.value = value || '#000000'; // Default color if no value provided
            } else if (key === 'textPosition') {
                // Special handling for aggregateOption in binary-layout
                input = document.createElement('select');
                input.classList.add('form-control');
                input.setAttribute('id', `${type}-${key}`);
                input.setAttribute('name', `${type}-${key}`);
                ['branch_bottom', 'branch_up', 'branch_right', 'aligned'].forEach(optionValue => {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionValue;
                    if (optionValue === value) {
                        option.selected = true;
                    }
                    input.appendChild(option);
                });
            } else if (key === 'symbolOption') {
                // Special handling for aggregateOption in binary-layout
                input = document.createElement('select');
                input.classList.add('form-control');
                input.setAttribute('id', `${type}-${key}`);
                input.setAttribute('name', `${type}-${key}`);
                ['circle', 'square', 'triangle'].forEach(optionValue => {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionValue;
                    if (optionValue === value) {
                        option.selected = true;
                    }
                    input.appendChild(option);
                });
            } else if (key === 'aggregateOption') {
                // Special handling for aggregateOption in binary-layout
                input = document.createElement('select');
                input.classList.add('form-control');
                input.setAttribute('id', `${type}-${key}`);
                input.setAttribute('name', `${type}-${key}`);
                ['gradient', 'aggregate'].forEach(optionValue => {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionValue;
                    if (optionValue === value) {
                        option.selected = true;
                    }
                    input.appendChild(option);
                });
            } else if (key == "barplotColorOption") {
                input = document.createElement('select');
                input.classList.add('form-control');
                input.setAttribute('id', `${type}-${key}`);
                input.setAttribute('name', `${type}-${key}`);
            } else if (key == "barplotFillProperty") {
                input = document.createElement('select');
                input.classList.add('form-control');
                input.setAttribute('id', `${type}-${key}`);
                input.setAttribute('name', `${type}-${key}`);
            } else if (key === 'barplotColor') {
                input = document.createElement('input');
                input.setAttribute('type', 'color'); // Explicitly set type="color"
                input.setAttribute('id', `${type}-${key}`);
                input.setAttribute('name', `${type}-${key}`);
                input.classList.add('form-control');
                input.value = value || '#000000'; // Default color if no value provided
            } else {
                // Handle general input types
                input = document.createElement('input');
                input.setAttribute('id', `${type}-${key}`);
                input.setAttribute('name', `${type}-${key}`);
                input.classList.add('form-control');

                // Adjust input type based on value
                if (typeof value === 'number') {
                    input.setAttribute('type', 'number');
                    input.value = value;
                } else if (typeof value === 'string' && value.startsWith('#')) {
                    input.setAttribute('type', 'color');
                    input.value = value;
                } else {
                    input.setAttribute('type', 'text');
                    input.value = value || '';
                }
            }

            container.appendChild(label);
            container.appendChild(input);

            return container;
        }

        // Handle Edit Button Click
        tableBody.addEventListener('click', function (e) {
            if (e.target.closest('.btn-outline-primary')) {
                const layoutName = e.target.closest('tr').querySelector('td').innerText.trim();
                populateEditForm(layoutName);
                const editModal = new bootstrap.Modal(document.getElementById('editLayoutModal'));
                editModal.show();
            }
        });

        // Save changes and update layoutsMetadataInput
        document.getElementById('saveLayoutChanges').addEventListener('click', () => {
            const layoutName = document.getElementById('editLayoutName').value;
            const layout = layoutsMetadata.find(l => l.layout_name === layoutName);

            if (layout) {
                // Update Config Fields
                const configContainer = document.getElementById('configFieldsContainer');
                layout.config = {};
                Array.from(configContainer.querySelectorAll('input, select')).forEach(input => {
                    const key = input.name.split('-')[1];
                    layout.config[key] = input.type === 'number' ? parseFloat(input.value) || 0 : input.value;
                });

                // Update Layer Fields
                const layerContainer = document.getElementById('layerFieldsContainer');
                layout.layer = {};
                Array.from(layerContainer.querySelectorAll('input, select')).forEach(input => {
                    const key = input.name.split('-')[1];
                    layout.layer[key] = input.type === 'number' ? parseFloat(input.value) || 0 : input.value;
                });

                // Update the hidden input with the new metadata
                updateHiddenInput();

                // Close the modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editLayoutModal'));
                editModal.hide();

                console.log('Updated Layout:', layout);
            }
        });

        // === End of Edit Layout Functionality ===

        // Handle Apply Changes Button
        document.getElementById('applyChangesBtn').addEventListener('click', function () {
            fetch('/explore_tree/{{ treename }}', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    updated_metadata: layoutsMetadataInput.value
                })
            })
            .then(response => response.text())
            .then(data => {
                alert("Layouts metadata updated successfully!");
                location.reload();
            })
            .catch(error => console.error('Error:', error));
        });
    });

</script>

<script>
    // this is for layout toggle settings
    $(document).ready(function (){
        setupEventListeners();
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        // Define a mapping for the Python class names to user-friendly types
        const typeMapping = {
            "float": "Numerical",
            "int": "Numerical",
            "str": "Categorical",
            "list": "List",
            "bool": "Binary"
        };

        // Select all rows in the properties table
        document.querySelectorAll('#propertiesTable .propType').forEach(cell => {
            const rawType = cell.textContent.trim(); // e.g., "<class 'float'>"
            const typeName = rawType.match(/<class '(\w+)'>/); // Extract the type name, e.g., "float"
            if (typeName && typeName[1] in typeMapping) {
                cell.textContent = typeMapping[typeName[1]]; // Replace with user-friendly type
            } else {
                cell.textContent = "Unknown"; // Default to "Unknown" if no mapping exists
            }
        });
    });

    function setupEventListeners(){
        document.getElementById('layout').addEventListener('change', function () {
            const selectedLayout = this.value;
            // Check if the selected layout is one of the categorical layouts
            const categoricalLayouts = [
                "colorbranch-layout",
                "label-layout",
                "rectangle-layout",
                "categorical-bubble-layout",
                "background-layout",
                "categorical-matrix-layout",
                "piechart-layout",
                "profiling-layout",
                "nodesymbol-layout"
            ];

            if (categoricalLayouts.includes(selectedLayout)) {
                $('#categoricalSettings').show();
            } else {
                $('#categoricalSettings').hide();
            }

            if (selectedLayout === "textbranch-layout") {
                $('#categoricalSettings').hide();
                $('#textbranchSettings').show();
            } else {
                $('#categoricalSettings').show();
                $('#textbranchSettings').hide();
            }

            if (selectedLayout == "nodesymbol-layout") {
                $('#nodesymbolSettins').show();
            } else {
                $('#nodesymbolSettins').hide();
            }

            if (selectedLayout === "binary-layout") {
                $('#binarySettings').show();
            } else {
                $('#binarySettings').hide();
            }

            // numerical layout settings
            // Detect if a layout option is numerical
            const numericalLayouts = [
                "branchscore-layout", "heatmap-layout", "heatmap-mean-layout",
                "heatmap-zscore-layout", "numerical-matrix-layout",
                "numerical-bubble-layout"
            ];
            if (numericalLayouts.includes(selectedLayout)) {
                $('#numericalSettings').show();
                $('#internalNumerical').show();
            } else {
                $('#numericalSettings').hide();
                $('#internalNumerical').hide();
            }
            
            // numerical-matrix specific settings
            // Target the specific row containing minVal and maxVal within numericalSettings
            const numericalSettingsSection = document.getElementById('numericalSettings');
            const minMaxRow = numericalSettingsSection.querySelector('.row.g-3');

            // Disable minVal and maxVal inputs for numerical-matrix-layout
            if (selectedLayout === 'numerical-matrix-layout') {
                // Disable inputs
                minMaxRow.querySelectorAll('input#minVal, input#maxVal').forEach(input => {
                    input.disabled = true;
                });
                minMaxRow.style.opacity = '0.5'; // Optional: Indicate inactive state
            } else {
                // Enable inputs for other layouts
                minMaxRow.querySelectorAll('input#minVal, input#maxVal').forEach(input => {
                    input.disabled = false;
                });
                minMaxRow.style.opacity = '1'; // Reset opacity
            }

            // Barplot layout settings
            if (selectedLayout === "barplot-layout") {
                $('#barplotOptions').show();
            } else {
                $('#barplotOptions').hide();
            }
            // Toggle color picker or property selector based on color option choice
            $('#barplotColorOption').change(function () {
                if ($(this).val() === 'same') {
                    $('#barplotColorScheme').show();
                    $('#barplotFillProperty').hide();
                    $('#customColorWrapper').hide();
                } else if ($(this).val() === 'colorby') {
                    $('#barplotColorScheme').hide();
                    $('#barplotFillProperty').show();
                    $('#customColorWrapper').hide();
                } else if ($(this).val() === 'custom') {
                    $('#barplotColorScheme').hide();
                    $('#barplotFillProperty').hide();
                    $('#customColorWrapper').show();
                };
            });

            // Alignment layout settings
            if (selectedLayout === "alignment-layout") {
                $('#alignmentSettings').show();
                $('#propsSelection').hide();
                $('#generalSettings').hide();
            } else {
                $('#alignmentSettings').hide();
                $('#propsSelection').show();
                $('#generalSettings').show();
            }

            // Domain layout settings
            if (selectedLayout === "domain-layout") {
                $('#propsSelection').hide();
                $('#generalSettings').hide();
            } else {
                $('#propsSelection').show();
                $('#generalSettings').show();
            }
        });
        
        document.getElementById('customQueryType').addEventListener('change', toggleQueryFields);
        document.getElementById('clearQueryBox').addEventListener('click', clearQueryBox);
        document.getElementById('addQueryBtn').addEventListener('click', addInitialQueryPart);
        
        // text branch and color
        const binaryunicolorOption = document.getElementById('binaryunicolorOption');
        const binaryunicolorPicker = document.getElementById('binaryunicolorPicker');
        const binaryColorScheme = document.getElementById('binaryColorScheme');
        binaryunicolorOption.addEventListener('change', () => {
            if (binaryunicolorOption.checked) {
                binaryunicolorPicker.style.display = 'block';
                binaryColorScheme.style.display = 'none';
            } else {
                binaryunicolorPicker.style.display = 'none';
                binaryColorScheme.style.display = 'block';

            }
        });
        const textunicolorOption = document.getElementById('textunicolorOption');
        const textunicolorPicker = document.getElementById('textunicolorPicker');
        const textColorscheme = document.getElementById('textColorscheme')

        const textPosition = document.getElementById('textPosition')
        textunicolorOption.addEventListener('change', () => {
            if (textunicolorOption.checked) {
                textunicolorPicker.style.display = 'block';
                textColorscheme.style.display = 'none';
            } else {
                textunicolorPicker.style.display = 'none';
                textColorscheme.style.display = 'block';
            }
        });
    };

    
</script>
<script>
    // this is for custom query settings
    /*********************
     * Query Management Functions
     *********************/
    let queryParts = [];
    document.getElementById('addWithAnd').addEventListener('click', function () {
        document.getElementById('addQueryBtn').innerText = 'AND';
    });

    document.getElementById('addWithOr').addEventListener('click', function () {
        document.getElementById('addQueryBtn').innerText = 'OR';
    });

    function resetQueryButton() {
        document.getElementById('addQueryBtn').innerText = 'ADD';
        queryParts = [];
        document.getElementById('queryBox').value = '';
    }

    function addInitialQueryPart() {
        // Check if the queryBox is empty
        if (document.getElementById('queryBox').value === '') {
            // Pass the operator to addQueryPart
            addQueryPart();
        } else{
            // Get the operator from the Add Query button's inner text
            const operator = document.getElementById('addQueryBtn').innerText.trim();
            if (operator === 'AND' || operator === 'OR') {
                addQueryPart(operator);
            } else {
                alert("Please select an operator before adding another query part.");
            }
        }
    }

    function addQueryPart(operator = '') {
        const queryType = document.getElementById('customQueryType').value;
        const prop = document.getElementById('queryProp').value.trim();
        const operation = document.getElementById('queryOperation').value;
        const value = document.getElementById('queryValue').value.trim();
        const counterInputElement = document.querySelector('.counter-input');
        const counterValue = counterInputElement ? counterInputElement.value : null;

        if (!queryType) {
            alert("Please select a query type.");
            return;
        }

        if (!prop || !value) {
            alert("Please fill in all query fields.");
            //resetQueryButton();
            return;
        }

        // Build the query part
        const queryPart = counterValue ? `${prop}:${counterValue} > ${value}` : `${prop} ${operation} ${value}`;
        
        // Add the operator at the beginning if it's valid and there are existing query parts
        const fullQueryPart = (operator && queryParts.length > 0 && (operator === 'AND' || operator === 'OR')) 
            ? `${operator} ${queryPart}` 
            : queryPart;

        // Push the full query part to the queryParts array
        queryParts.push(fullQueryPart);

        // Update the query box with all query parts
        document.getElementById('queryBox').value = queryParts.join(' ') + ';';

        // Reset the input fields for the next query
        document.getElementById('queryValue').value = '';
    }

    function clearQueryBox(event) {
        event.preventDefault();
        document.getElementById('queryBox').value = '';
        queryParts = [];
        resetQueryButton();
    }
    
    function toggleQueryFields() {
        const queryType = document.getElementById('customQueryType').value;
        const queryFields = document.getElementById('queryFields');
        const taxonomicOptions = document.getElementById('taxonomicOptions');

        if (queryType === 'rank_limit') {
            queryFields.style.display = 'none';
            taxonomicOptions.style.display = 'block';
        } else {
            queryFields.style.display = 'block';
            taxonomicOptions.style.display = 'none';
        }
        resetQueryButton();
    }

    /*********************
     * Additional Input Handlers
     *********************/
    // Function to handle dynamic counter input addition
    function handleDynamicCounterInput() {
        const selectedProperty = document.getElementById('queryProp').value;
        const dynamicCounterPropsContainer = document.getElementById('dynamicCounterProps');

        // Check if the selected property ends with '_counter'
        if (selectedProperty.endsWith('_counter')) {
            // Check if the input field for this property already exists
            if (!document.getElementById(`input-${selectedProperty}`)) {
                // Create a new input field for the selected property
                const counterField = `
                    <div class="form-group mt-3" id="input-${selectedProperty}">
                        <label for="counterInput-${selectedProperty}">Prop for ${selectedProperty}</label>
                        <input type="text" class="form-control counter-input"
                            id="counterInput-${selectedProperty}"
                            data-prop="${selectedProperty}"
                            placeholder="Enter Counter value">
                    </div>`;
                // Append the new field to the container
                dynamicCounterPropsContainer.innerHTML = counterField;
            }
        } else {
            // Remove all counter input fields if the selected property doesn't end with '_counter'
            dynamicCounterPropsContainer.innerHTML = '';
        }
    }



    function removeCounterInputField(e) {
        const unselectedProperty = e.params.data.id;
        if (unselectedProperty.endsWith('_counter')) {
            $(`#input-${unselectedProperty}`).remove();
            $('#queryResult').val('');
        }
    }

    document.getElementById('sendQuery').addEventListener('click', () => {
        // Retrieve query type and query value
        const queryType = document.getElementById('customQueryType')?.value || null;
        const query = document.getElementById('queryBox')?.value || null;
        console.log("Query Type:", queryType, "Query:", query);
        
        // Ensure a valid queryType is selected
        if (!queryType) {
            alert('Please select a query type before sending.');
            return;
        } 
        
        if (!query) {
            if (queryType !== 'rank_limit') {
                alert('Please add a query before sending.');
                return;
            }
        };

        if (queryType === 'rank_limit'){
            const rankSelection = document.getElementById('rankSelection').value;
            if (!rankSelection) {
                alert('Please select a taxonomic rank before sending.');
                return;
            }
        } 

        // Form the layer object
        if (queryType === 'rank_limit') {
            const query = null;
            const rankSelection = document.getElementById('rankSelection').value;
            console.log("checking rank selection", rankSelection);
            const layer = {
                queryType,
                query,
                rankSelection
            };
            // Add the layer to the layers array
            layers.push(layer);
        } else if (queryType === 'highlight' || queryType === 'collapse' || queryType === 'prune') {
            const rankSelection = null;
            const layer = {
                queryType,
                query,
                rankSelection
            };
            // Add the layer to the layers array
            layers.push(layer);
        }
        

        

        // Collect additional general settings
        const layersData = JSON.stringify(layers);
        const columnWidth = document.getElementById('columnWidth')?.value || null;
        const paddingX = document.getElementById('paddingX')?.value || null;
        const paddingY = document.getElementById('paddingY')?.value || null;

        // Numerical-specific setting
        let internalNumRep = null;
        const numericalLayouts = [
            "branchscore-layout",
            "heatmap-layout",
            "heatmap-mean-layout",
            "heatmap-zscore-layout",
            "barplot-layout",
            "numerical-matrix-layout",
            "numerical-bubble-layout",
        ];
        if (layers.some(layer => numericalLayouts.includes(layer.layout))) {
            internalNumRep = document.getElementById('internalNumRep')?.value || null;
        }

        // Construct the form data object
        const formData = {
            layers: layersData,
            column_width: columnWidth,
            padding_x: paddingX,
            padding_y: paddingY,
            internal_num_rep: internalNumRep
        };

        // Send the form data to the backend
        $.post(
            '/explore_tree/{{treename}}',
            formData,
            (response) => {
                console.log('Query sent successfully:', response);
                //alert('Query added successfully!');
                window.location.reload(); // Refresh the page after successful submission
            }
        ).fail((error) => {
            console.error('Error sending query:', error);
            alert('Failed to send query. Please try again.');
        });
    });

    // Attach the change event listener to the queryProp dropdown
    document.getElementById('queryProp').addEventListener('change', handleDynamicCounterInput);
    $('#queryProp').on('select2:unselect', removeCounterInputField);
</script>
<script>
    // Get references to the toggle button and wrapper
    // const toggleControlPanelBtn = document.getElementById('toggleControlPanel');
    // const controlPanelWrapper = document.getElementById('controlPanelWrapper');

    // // Add click event to toggle the minimized state
    // toggleControlPanelBtn.addEventListener('click', () => {
    //     controlPanelWrapper.classList.toggle('minimized');
    //     // Update button icon
    //     if (controlPanelWrapper.classList.contains('minimized')) {
    //         toggleControlPanelBtn.innerHTML = '&#x25B2;'; // Up arrow for minimized state
    //     } else {
    //         toggleControlPanelBtn.innerHTML = '&#x25BC;'; // Down arrow for expanded state
    //     }
    // });

    // this is for fullscreen settings
    const togglebtn = document.getElementById("fullscreenBtn");
    const iframe = document.getElementById("treeIframe");

    togglebtn.addEventListener("click", function () {
        if (iframe.requestFullscreen) {
            iframe.requestFullscreen();
        } else if (iframe.mozRequestFullScreen) { // Firefox
            iframe.mozRequestFullScreen();
        } else if (iframe.webkitRequestFullscreen) { // Chrome,Safari,Opera
            iframe.webkitRequestFullscreen();
        } else if (iframe.msRequestFullscreen) { // I.E, Edge
            iframe.msRequestFullscreen();
        }
    });
</script>
</body>
</html>
